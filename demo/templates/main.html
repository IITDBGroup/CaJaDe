<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>

	<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>	
  <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
  <!-- <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
  <!-- <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script> -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v1.js"></script>
	<link rel="stylesheet" href='../static/main.css'>
  <!-- <link rel="stylesheet" type="text/css" href="static/main.css"> -->
	
	<title>Main</title>
</head>
<body>

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Top Navbar %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">CaJaDE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
                <button type="button" class="btn btn-primary btn-md dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  DB Info
                </button>
                <div class="dropdown-menu">
                   <form id="db-credentials" action="{{ url_for('db_connect')}}" method="post">
                       <label for="dbname">DB Name:</label>
                       <input type="text" id="dbname" name="dbname">
                       
                       <label for="dbpswd">DB Password:</label>
                       <input type="password" id="dbpswd" name="dbpswd">
                       
                       <label for="dbusr">DB User:</label>
                       <input type="text" id="dbusr" name="dbusr">
                       
                       <label for="dbport">DB Port:</label>
                       <input type="text" id="port" name="port" placeholder="5432">

                       <label for="dbhost">DB Host:</label>
                       <input type="text" id="host" name="host" placeholder="127.0.0.1">

                       <button type="submit" class="btn btn-primary">Connect</button>
                       <button type="button" class="btn btn-secondary">Disconnect</button> 
                   </form>
                </div> 
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Params</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Schema Graph</a>
            </li>
          </ul>
        </div>
    </div>
</nav>

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div class="container-fluid">
    <div class="row">
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        {% set active_table = active_table|default("adult") %}
        <ul class="nav flex-column mb-2">
            {% for i in db_tables %}
                <li class="nav-item">
                    <a {% if i|string == active_table|string %}class="active nav-link"
                                                   {% else %}class="nav-link"{% endif %}
                       href="{{ url_for('db_connect', active_table=i)|e }}">
                        <span data-feather="file-text"></span>{{ i }}{{ caption|e }}
                    </a>
                </li>

            {% endfor %}
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
            <span>Table Schemas</span>
            <a class="d-flex align-items-center text-muted" href="#">
                <span data-feather="plus-circle"></span>
            </a>
        </h6>

        <ul class="nav flex-column mb-2 attr-list">
            {% if db_datatype is defined%}
              {% for attr in db_datatype[active_table] %}
                <li class="form-check nav-item">
                    <label class="form-check-label" for="{{ attr[0] }}">{{ attr[0] }}{{ caption|e }}</label>
                    <input class="form-check-input ml-2" type="checkbox" name="{{ attr[0] }}" value=""
                           id="checkbox-{{ attr[0] }}"
                           {% if attr[1] == 'character' %}checked{% endif %}>
<!--                 <svg width="10" height="10" class="float-right mr-2">
                    <rect x="0" y="0" width="10" height="10" fill="none" id="rec-score-rect-{{ attr[0] }}"/></svg> -->
                </li>
              {% endfor %}
            {% endif %}
        </ul>

      <!-- <h5>{{ db_connection_info }}</h5> -->
      </nav>

      <div class="col-md-7">
        <form id="query-form" method="POST" action="/run">
            <div class="col-auto">
              <div class="input-group">
                <div class="input-group-text">SELECT</div>
                <input type="text" class="form-control" id="query-select" name="query-select">
                <div class="input-group-text">,</div>
                <input type="text" class="form-control" id="query-aggregate" placeholder="COUNT(*)" name="query-aggregate">
                <div class="input-group-text">FROM</div>
                <input type="text" class="form-control" id="query-from" name="query-from">
                <div class="input-group-text">GROUP BY</div>
                <input type="text" class="form-control" id="query-group" name="query-group">
                
                <!--Run button -->
                <div class="input-group-run">  
                  <!-- <input type="button" id="execute" value="run"> -->
                  <button type="button" class="btn btn-outline-primary" id="execute">Run</button>                   
                </div>
       
            </div>
      	</form>


		<script>
      var colNum;

		  $('#execute').click(function(){
		    let dataList;
		    let totalNum;
		    //var colNum;
		    let colData;
		    let tblData;
		    let dataPerPage;
		    let pageCount = 5;
		    let globalCurrentPage = 1;
		    var cnt;
		    var html;

        //let sltList = [];
		    
		    dataPerPage = $("#dataPerPage").val();
		  
		    var slt = $('#query-select').val();
		    var agg = $('#query-aggregate').val();
		    var frm = $('#query-from').val();
		    var grp = $('#query-group').val();
		    
		    var postdata = {
		      'slt':slt, 'agg':agg, 'frm':frm, 'grp':grp
		    }
		    $.ajax({
		      type: 'POST',
		      url: '{{url_for("ajax")}}',
		      data: JSON.stringify(postdata),
		      dataType: 'JSON',
		      contentType: "application/json",
		      success: function(data){	
		        totalNum = data.result2.length;
		        colNum = data.result2[0].length;
		        colData = data.result3;
		        tblData = data.result2;

            $("#sltROWScount").empty();
            $('#container').empty();
            selectedArr = [];
            tdArr = [];
            sltROWS = 0;

		        displayData(1, dataPerPage);
		        paging(totalNum, dataPerPage, pageCount, 1);
            selectRows();
            /***
		        $("#dataPerPage").change(function () {
		          dataPerPage = $("#dataPerPage").val();
		          paging(totalNum, dataPerPage, pageCount, globalCurrentPage);
		          displayData(globalCurrentPage, dataPerPge);
		        });
            ***/

		      },
		      error: function(request, status, error){ 
		        alert('ajax failed')
		        alert(error);
		      }

		    })
		    
        $("#dataPerPage").change(function () {
		      dataPerPage = $("#dataPerPage").val();
          displayData(1, dataPerPage);
		      paging(totalNum, dataPerPage, pageCount, 1);

		      //paging(totalNum, dataPerPage, pageCount, globalCurrentPage);
		      //displayData(globalCurrentPage, dataPerPge);
		    });

		    function paging(totalNum, dataPerPage, pageCount, currentPage){
		      let totalPageNum = Math.ceil(totalNum/dataPerPage);
		      if(totalPageNum < pageCount){
		        pageCount = totalPageNum;
		      }
		      let pageGroup = Math.ceil(currentPage/pageCount);
		      let last = pageGroup*pageCount;
		      
		      if(last>totalPageNum){
		        last = totalPageNum;
		      }
		      let first = last - (pageCount -1);
		      let next = last + 1;
		      let prev = first - 1;
		      let pageHtml = "";
		      
		      pageHtml += "<nav aria-label=\"Page navigation example\"><ul class=\"pagination\">";

		      if(prev > 0){
            pageHtml += "<li><a class=\"page-link\" href='#' id='prev' aria-label=\"Previous\"><span aria-hidden=\"true\">&laquo;</span><span class=\"sr-only\">Previous</span></a></li>";		       
		      }
		      for(var i = first; i<=last; i++){ 
		        if(currentPage == i){
              pageHtml += "<li class='on'><a class=\"page-link\" href='#' id='"+i+"'>" + i + "</a></li>";

		        } else{
              pageHtml += "<li><a class=\"page-link\" href='#' id='"+i+"'>" + i + "</a></li>";

		        }
		      }
		      if(last<totalPageNum){
            pageHtml += "<li><a class=\"page-link\" href='#' id='next' aria-label=\"Next\"><span aria-hidden=\"true\">&raquo;</span><span class=\"sr-only\">Next</span></a></li>";
		      }
		      pageHtml += "</ul></nav>";
		      $("#pagingul").html(pageHtml);
		      
		      let displayCount = "";
		      let currentShowingPageFrom = (currentPage*dataPerPage)-dataPerPage+1;
		      let currentShowingPageTo = currentPage*dataPerPage;
          if(currentShowingPageTo > totalNum) currentShowingPageTo = totalNum;

		      displayCount = "Showing "+currentShowingPageFrom+" to "+currentShowingPageTo+" of "+totalNum+" entries";
		      $("#displayCount").text(displayCount);
		      
		      $("#pagingul li a").click(function (){
		        let $id = $(this).attr("id");
		        selectedPage = $(this).text();
		        
		        if($id == "next") selectedPage = next;
		        if($id == "prev") selectedPage = prev;
		        
		        globalCurrentPage = selectedPage;
		        
		        paging(totalNum, dataPerPage, pageCount, selectedPage);
		        displayData(selectedPage, dataPerPage);
		      });
		    }
		    function displayData(currentPage, dataPerPage){
		      let chartHtml = "";
		      currentPage = Number(currentPage);
		      dataPerPage = Number(dataPerPage);
		      
		      chartHtml = "<table class=\"table table-hover table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"example\">";
		      chartHtml += "<thead><tr>";
		      for(var i=0;i<colNum;i++){
		        chartHtml += "<th style=\"text-align: center;\">" + colData[i] + "</th>";
		      }
		      chartHtml += "</tr></thead>";
		      
          let tableFrom = (currentPage-1)*dataPerPage;
          let tableTo = (currentPage-1)*dataPerPage+dataPerPage;
          if(tableTo > totalNum) tableTo = totalNum;

		      chartHtml += "<tbody>";
          for(var i = tableFrom; i<tableTo;i++){
		        chartHtml += "<tr onclick=\"selectRows(this);\">";
		        for(var j=0;j<colNum;j++){
		          chartHtml += "<td style=\"text-align: center;\">" + tblData[i][j] + "</td>";
		        }
		        chartHtml += "</tr>";
		      }
		      chartHtml += "</tbody></table>";
		      
		      $("#display").empty();
		      $("#display").append(chartHtml);
          
		  }
		 

		  })

		  let sltROWS = 0;
      var selectedArr = new Array();
      let sltROWScnt = "Total Selected Rows: ";

      var str="";
      var tdArr = new Array();
      var td;

      function selectRows(){
        $("#example tbody tr").click(function(){
          var text = $(this).text();          
          var tr = $(this);
          td = tr.children();

          let cnt = selectedArr.indexOf(text);
          let len = selectedArr.length;

          if(cnt<0 && len<2){
                       
              sltROWS += 1;
              selectedArr.push(text);
              $(this).css("background-color", "#e0e0e0");

              $("#sltROWScount").empty();
		          $("#sltROWScount").append(sltROWScnt);
              $("#sltROWScount").append(sltROWS);

              $('#container').empty();
              $('#container').append(
                "<button onclick=\"exp()\" type=\"button\" class=\"btn btn-outline-primary\" id=\"explanation\">explanation</button>"
              );    

              td.each(function(i){
                tdArr.push(td.eq(i).text());
              })      
          }

        })
      }
      function exp(){
        var expTEXT = "";
        for(var i=0;i<tdArr.length;i++){
          expTEXT += tdArr[i];
          expTEXT += " ";
        }
        alert(expTEXT);
        

        //////   
        alert("0, colNum:"+colNum); //colNum data can not be accessed
		    var postdata_exp = { 'tdArr': tdArr, 'colNum': colNum }
        alert("1");

        $.ajax({
          type: 'EXP',
          url: '{{url_for("explanation")}}',
          data: JSON.stringify(postdata_exp),
          dataType: 'JSON',
          contentType: "application/json",
          success: function(data){
            if (data){
              alert("complete");
            } 
            else {
              alert("No data");
            }
            //var rs = data.result;
            //alert(rs);
            //alert("success-explanation");
          },
		      error: function(request, status, error){ 
		        alert('ajax failed')
		        alert(error);
		      }
          })
          alert("2");

        
        //////
      }
		</script>
    

    <script>
      
    </script>
		<br>
		
		<div class="row">	
		  <div style="display: inline;">
        <div style="float: left; width: 33%; padding: 10px;">
		      <p>Show
		      <select id="dataPerPage" class="form-select" style="width: 70px; display: inline;" onchange="changeRowsSelect()">
		        <option value="10">10</option>
		        <option value="15">15</option>
		        <option value="20">20</option>
		      </select>
		      Rows</p>
		    </div>

        <div style="float: left; padding: 10px; width: 41%; text-align: right;" class="col-md-5">
          <p id="sltROWScount"></p>
        </div>
<!---
          <div style="display: inline;">
            <div style="float:left;"><p id="sltROWScount"></p></div>
            <div style="float: right;" id="container" class="d-grid gap-2 d-md-block"></div>
          </div>
-->
        <div style="float: right; width: 25%; text-align: right;" id="container"></div>
        
      </div>
		</div>

		<div id="display" style="overflow: auto;"></div><br>

		<div id="pageInfo" style="display: inline;" class="col-md-8">
		  <div style="float: left;">
		    <p id="displayCount"></p>
        <!--- <p id="sltROWScount"></p> -->
		  </div>
		  <div style="float: right;">
		    <ul id="pagingul" class="col-md-5"></ul>
		  </div>
		</div>


  <!--
    <div id="container"></div>

  
		<div style="float:right;" class="col-md-8">
      <button type="button" class="btn btn-outline-primary">Explanation</button>
    </div>
    -->
      </div>

    </div>
    <div class="col-md-3"> 
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div id="schemagraph"></div>
        <script>
          var svg = d3.select("#schemagraph")            
            .append("svg")
            .attr("width", 400)
            .attr("height", 300);

          svg.append("defs").append("marker")
              .attr("id", "arrow")
              .attr("viewBox", "5 -5 10 10")
              .attr("refX", 20)
              .attr("refY", 0)
              .attr("markerWidth", 8)
              .attr("markerHeight", 8)
              .attr("orient", "auto")
            .append("svg:path")
              .attr("d", "M0,-5L10,0L0,5");

          var width = svg.attr("width");
          var height = svg.attr("height");

          var graph = {{schema_graph_data|safe}};

          var simulation = d3
              .forceSimulation(graph.nodes)
              .force("link",d3.forceLink(graph.links).id(function(d) {return d.id;}).distance(120).links(graph.links))
              .force("charge", d3.forceManyBody().strength(-200))
              .force("center", d3.forceCenter(width / 2, height / 2))
              .on("tick", ticked);

            var link = svg.selectAll(".link")
                .data(graph.links)
                .enter()
                .append("g")
                .attr("class", "link")
                .append("line")
                .style("stroke", "blue")
                .attr("class", "link-line")
                .attr("marker-end", "url(#arrow)")
                .attr("stroke-width", function(d) {
                  return 3;
                });

            var linkText = svg.selectAll(".link")
                .append("text")
                .attr("class", "link-label")
                .attr("font-family", "Arial, Helvetica, sans-serif")
                .attr("fill", "Black")
                .style("font", "normal 12px Arial")
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(function(d) {
                    return d.type;
                });

            var drag = d3
              .drag()
              .on("start", dragstarted)
              .on("drag", dragged)
              .on("end", dragended);


            var nodes_with_text = svg
              .append("g")
              .selectAll("g")
              .data(graph.nodes)
              .enter()
              .append("g")
              .call(drag);

            var circles = nodes_with_text
              .append("circle")
              .attr("r", 15)
              .attr("fill", "red");

            var texts = nodes_with_text
              .append("text").text(function(d){
                return d.name
                }
              );

            function ticked() {

              nodes_with_text.attr("transform", function(d){
                return "translate(" + d.x + ", " + d.y + ")";
              });

              link
                .attr("x1", function(d) {
                  return d.source.x;
                })
                .attr("y1", function(d) {
                  return d.source.y;
                })
                .attr("x2", function(d) {
                  return d.target.x;
                })
                .attr("y2", function(d) {
                  return d.target.y;
                });

              linkText
                  .attr("x", function(d) {
                      return ((d.source.x + d.target.x)/2);
                  })
                  .attr("y", function(d) {
                      return ((d.source.y + d.target.y)/2);
                  });
            };

            function dragstarted(d) {
              if (!d3.event.active) simulation.alphaTarget(0.3).restart();
              d.fx = d.x;
              d.fy = d.y;
            };

            function dragged(d) {
              d.fx = d3.event.x;
              d.fy = d3.event.y;
            };

            function dragended(d) {
              if (!d3.event.active) simulation.alphaTarget(0);
              d.fx = null;
              d.fy = null;
            };
          </script>

        </script>
      </div>
    </div>
</div>    
</body>
</html>

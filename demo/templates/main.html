<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" crossorigin="anonymous"></script>

	<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>	
  <!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->
  <!-- <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
  <script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v1.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js'></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<link rel="stylesheet" href='../static/main.css'>

  <!-- <link rel="stylesheet" type="text/css" href="static/main.css"> -->
	
	<title>Main</title>
</head>
<body>

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Top Navbar %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">CaJaDE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item dropdown">
                <button type="button" class="btn btn-primary btn-md dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  DB Info
                </button>
                <div class="dropdown-menu">
                   <form id="db-credentials" action="{{ url_for('db_connect')}}" method="post">
                       <label for="dbname">DB Name:</label>
                       <input type="text" id="dbname" name="dbname">
                       
                       <label for="dbpswd">DB Password:</label>
                       <input type="password" id="dbpswd" name="dbpswd">
                       
                       <label for="dbusr">DB User:</label>
                       <input type="text" id="dbusr" name="dbusr">
                       
                       <label for="dbport">DB Port:</label>
                       <input type="text" id="port" name="port" placeholder="5432", value="5432">

                       <label for="dbhost">DB Host:</label>
                       <input type="text" id="host" name="host" placeholder="127.0.0.1", value="127.0.0.1">

                       <button type="submit" class="btn btn-primary">Connect</button>
                       <button type="button" class="btn btn-secondary">Disconnect</button> 
                   </form>
                </div> 
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Params</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">Schema Graph</a>
            </li>
          </ul>
        </div>
    </div>
</nav>

<!-- %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% -->

<div class="container-fluid">
    <div class="row">
      <nav class="col-md-2 d-none d-md-block bg-light sidebar">
        {% set active_table = active_table|default("adult") %}
        <ul class="nav flex-column mb-2">
            {% for i in db_tables %}
                <li class="nav-item">
                    <a {% if i|string == active_table|string %}class="active nav-link"
                                                   {% else %}class="nav-link"{% endif %}
                       href="{{ url_for('db_connect', active_table=i)|e }}">
                        <span data-feather="file-text"></span>{{ i }}{{ caption|e }}
                    </a>
                </li>

            {% endfor %}
        </ul>

        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
            <span>Table Schemas</span>
            <a class="d-flex align-items-center text-muted" href="#">
                <span data-feather="plus-circle"></span>
            </a>
        </h6>

        <ul class="nav flex-column mb-2 attr-list">
            {% if db_datatype is defined%}
              {% for attr in db_datatype[active_table] %}
                <li class="form-check nav-item">
                    <label class="form-check-label" for="{{ attr[0] }}">{{ attr[0] }}{{ caption|e }}</label>
                    <input class="form-check-input ml-2" type="checkbox" name="{{ attr[0] }}" value=""
                           id="checkbox-{{ attr[0] }}"
                           {% if attr[1] == 'character' %}checked{% endif %}>
<!--                 <svg width="10" height="10" class="float-right mr-2">
                    <rect x="0" y="0" width="10" height="10" fill="none" id="rec-score-rect-{{ attr[0] }}"/></svg> -->
                </li>
              {% endfor %}
            {% endif %}
        </ul>

      <!-- <h5>{{ db_connection_info }}</h5> -->
      </nav>

      <div class="col-md-6"> <!--//col-md-7-->
        <form id="query-form" method="POST" action="/run">
            <div class="col-auto" style="display: flex; flex-direction: column; justify-content: center;  ">
              <!--<div class="input-group"> -->
                <div class="input-group1">
                  <div class="input-group-text" style="float: left;">SELECT</div>
                  <input type="text" class="form-control" id="query-select" name="query-select" value = "count(*) as win, s.season_name" style="float: left; width: 30%;"><!--27%;--> 
                  <div class="input-group-text" style="float: left;">,</div>
                  <input type="text" class="form-control" id="query-aggregate" placeholder="COUNT(*)" name="query-aggregate" style="float: left; width: 21%;"><!--27%;-->  
                  <div class="input-group-text" style="float: left;">FROM</div>
                  <input type="text" class="form-control" id="query-from" name="query-from" value=" team t, game g, season s " style="float: left; width: 28%;">
                </div>
                <div class="input-group2">
                  <div class="input-group-text" style="float: left;">WHERE</div>
                  <input type="text" class="form-control" id="query-where" name="query-where" value=" t.team_id = g.winner_id and g.season_id = s.season_id and t.team= 'GSW' " style="float: left; width: 30%;">
                  <div class="input-group-text" style="float: left;">GROUP BY</div>
                  <input type="text" class="form-control" id="query-group" name="query-group" value="s.season_name" style="float: left; width: 27%;">
          
                  <div class="input-group-run" style="float: left;">   <!--left--> 
                    <button type="button" class="btn btn-outline-primary" id="execute" style="width: 100%;">Run</button><!--100%-->              
                  </div>
                </div>
            <!--</div>-->
      	</form>


		<script>
      var colNum;
      var colData;

		  $('#execute').click(function(){
		    let dataList;
		    let totalNum;
		    //var colNum;
		    //let colData;
		    let tblData;
		    let dataPerPage;
		    let pageCount = 5;
		    let globalCurrentPage = 1;
		    var cnt;
		    var html;

        //let sltList = [];
		    
		    dataPerPage = $("#dataPerPage").val();
		  
		    var slt = $('#query-select').val();
		    var agg = $('#query-aggregate').val();
		    var frm = $('#query-from').val();
        var where = $('#query-where').val();
		    var grp = $('#query-group').val();
		    
		    var postdata = {'slt':slt, 'agg':agg, 'frm':frm, 'where':where, 'grp':grp}
		    $.ajax({
		      type: 'POST',
		      url: '{{url_for("ajax")}}',
		      data: JSON.stringify(postdata),
		      dataType: 'JSON',
		      contentType: "application/json",
		      success: function(data){	
		        totalNum = data.result2.length;
		        colNum = data.result2[0].length;
		        colData = data.result3;
		        tblData = data.result2;

            $("#sltROWScount").empty();
            $('#container').empty();
            selectedArr = [];
            tdArr = [];
            sltROWS = 0;

		        displayData(1, dataPerPage);
		        paging(totalNum, dataPerPage, pageCount, 1);
            //selectRows();
            /***
		        $("#dataPerPage").change(function () {
		          dataPerPage = $("#dataPerPage").val();
		          paging(totalNum, dataPerPage, pageCount, globalCurrentPage);
		          displayData(globalCurrentPage, dataPerPge);
		        });
            ***/

		      },
		      error: function(request, status, error){ 
		        alert('ajax failed')
		        alert(error);
		      }
		    })
		    
        $("#dataPerPage").change(function () {
		      dataPerPage = $("#dataPerPage").val();
          displayData(1, dataPerPage);
		      paging(totalNum, dataPerPage, pageCount, 1);

		      //paging(totalNum, dataPerPage, pageCount, globalCurrentPage);
		      //displayData(globalCurrentPage, dataPerPge);
		    });

		    function paging(totalNum, dataPerPage, pageCount, currentPage){
		      let totalPageNum = Math.ceil(totalNum/dataPerPage);
		      if(totalPageNum < pageCount){
		        pageCount = totalPageNum;
		      }
		      let pageGroup = Math.ceil(currentPage/pageCount);
		      let last = pageGroup*pageCount;
		      
		      if(last>totalPageNum){
		        last = totalPageNum;
		      }
		      let first = last - (pageCount -1);
		      let next = last + 1;
		      let prev = first - 1;
		      let pageHtml = "";
		      
		      pageHtml += "<nav aria-label=\"Page navigation example\"><ul class=\"pagination\">";

		      if(prev > 0){
            pageHtml += "<li><a class=\"page-link\" href='#' id='prev' aria-label=\"Previous\"><span aria-hidden=\"true\">&laquo;</span><span class=\"sr-only\">Previous</span></a></li>";		       
		      }
		      for(var i = first; i<=last; i++){ 
		        if(currentPage == i){
              pageHtml += "<li class='on'><a class=\"page-link\" href='#' id='"+i+"'>" + i + "</a></li>";

		        } else{
              pageHtml += "<li><a class=\"page-link\" href='#' id='"+i+"'>" + i + "</a></li>";

		        }
		      }
		      if(last<totalPageNum){
            pageHtml += "<li><a class=\"page-link\" href='#' id='next' aria-label=\"Next\"><span aria-hidden=\"true\">&raquo;</span><span class=\"sr-only\">Next</span></a></li>";
		      }
		      pageHtml += "</ul></nav>";
		      $("#pagingul").html(pageHtml);
		      
		      let displayCount = "";
		      let currentShowingPageFrom = (currentPage*dataPerPage)-dataPerPage+1;
		      let currentShowingPageTo = currentPage*dataPerPage;
          if(currentShowingPageTo > totalNum) currentShowingPageTo = totalNum;

		      displayCount = "Showing "+currentShowingPageFrom+" to "+currentShowingPageTo+" of "+totalNum+" entries";
		      $("#displayCount").text(displayCount);
		      
		      $("#pagingul li a").click(function (){
		        let $id = $(this).attr("id");
		        selectedPage = $(this).text();
		        
		        if($id == "next") selectedPage = next;
		        if($id == "prev") selectedPage = prev;
		        
		        globalCurrentPage = selectedPage;
		        
		        paging(totalNum, dataPerPage, pageCount, selectedPage);
		        displayData(selectedPage, dataPerPage);
		      });
		    }       

		    function displayData(currentPage, dataPerPage){
		      let chartHtml = "";
		      currentPage = Number(currentPage);
		      dataPerPage = Number(dataPerPage);
		      
		      chartHtml = "<table class=\"table table-hover table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"example\">";
		      
          chartHtml += "<thead><tr>";
		      for(var i=0;i<colNum;i++){
		        chartHtml += "<th style=\"text-align: center;\">" + colData[i] + "</th>";
		      }
		      
		      chartHtml += "</tr></thead>";

          let tableFrom = (currentPage-1)*dataPerPage;
          let tableTo = (currentPage-1)*dataPerPage+dataPerPage;
          if(tableTo > totalNum) tableTo = totalNum;

		      chartHtml += "<tbody>";
          for(var i = tableFrom; i<tableTo;i++){
            let txtTMP = "";

            for(var j=0;j<colNum;j++){txtTMP += tblData[i][j];}
            if(selectedArr.indexOf(txtTMP) != -1){ chartHtml += "<tr onclick=\"selectRows(this);\" style=\"background-color: #e0e0e0;\">";}
            else{chartHtml += "<tr onclick=\"selectRows(this);\">";}

		        for(var j=0;j<colNum;j++){chartHtml += "<td style=\"text-align: center;\">" + tblData[i][j] + "</td>";}
		        chartHtml += "</tr>";
		      }
		      chartHtml += "</tbody></table>";
		      
		      $("#display").empty();
		      $("#display").append(chartHtml);          
		    }
		  })

		  let sltROWS = 0;
      var selectedArr = new Array();
      let sltROWScnt = "Total Selected Rows: ";

      var str="";
      var tdArr = new Array();
      var td;
      var cnt;
      var len;
      var green_color="#2fdf28";
      var purple_color="#bb0ef1";
      var purple_text=null;
      var green_text=null;
      var count=0;
      var haspurple=false;

      function selectRows(elem){        
        bgcolor = $(elem).css("background-color");
        var text = $(elem).text();
        console.log(text);          
        var tr = $(elem);
        td = tr.children();

        cnt = selectedArr.indexOf(text);
        len = selectedArr.length;

        // if(bgcolor == "#e0e0e0"){
        if(selectedArr.includes(text))
        {
          if(text==green_text){
            green_text=null;
          }
          else{
            purple_text=null;
          }
          $(elem).css("background-color", "#FFFFFF");    
          sltROWS -= 1;
          selectedArr.splice(cnt,1);

          $("#sltROWScount").empty();
          $("#sltROWScount").append(sltROWScnt);
          $("#sltROWScount").append(sltROWS);
          $('#container').empty();
          $('#container').append(
            "<button onclick=\"exp()\" type=\"button\" class=\"btn btn-outline-primary\" id=\"explanation\" style=\"width:100%;\">explanation</button>"
          ); 

          td.each(function(i){
            var index = tdArr.indexOf(td.eq(i).text());
            if(index>-1){
              tdArr.splice(index, 1);
            }
          })
        }
        else {
          if(cnt==-1 && len<2){
            if(green_text==null){
              $(elem).css("background-color", green_color);
              green_text=text;      
            }
            else{
              $(elem).css("background-color", purple_color);
              purple_text=text;      
            }
            // $(elem).css("background-color", "#e0e0e0");            
            sltROWS += 1;
            selectedArr.push(text);

            $("#sltROWScount").empty();
            $("#sltROWScount").append(sltROWScnt);
            $("#sltROWScount").append(sltROWS);

            $('#container').empty();
            $('#container').append(
              "<button onclick=\"exp()\" type=\"button\" class=\"btn btn-outline-primary\" id=\"explanation\" style=\"width:100%;\">explanation</button>"
            );    

            td.each(function(i){
              tdArr.push(td.eq(i).text());
            })      
          } 
        }
      }
/////////////////////////////////////@@@@@@@@@@@@@@@@@@
      var exp_len, exp_data, highlightTextList;
      var color_matching = [];

      function checkOne(element){
        console.log("checkOne>>>>>");
        const checkboxes = document.getElementsByName("user_checkBox");
        checkboxes.forEach((cb) => { cb.checked = false;})
        element.checked = true;

        var checkbox = $("input[name=user_checkBox]:checked");
        checkbox.each(function(i){
          var tr = checkbox.parent().parent().eq(i);
          var td = tr.children();
          var pdes = td.eq(0).text();
          console.log("^^^^^^^checkbox pdes:^^^^^^", pdes); ///////////////@@@@@@@@@@@@@@
          expParser(pdes);
        });
      }
      function expParser(pdes){
        var tmp = pdes.split(',');
        var newNodeList = [];
        var newTargetNodeList = [];
        
        tmp.forEach(function(d){
          var splitByPeriod = d.split('.');
          var targetNode = splitByPeriod[0];
          var node = d.replace(targetNode+".","");
          var targetNode = targetNode.slice(0,-2); //split("_")[0];
          
          // var splitByEq = d.split('=');
          // var node = splitByEq[1];
          // var targetNode = splitByEq[0].split('_')[0];
          console.log("***********node | targetNode: ", node, " | ", targetNode);
          newNodeList.push(node);
          newTargetNodeList.push(targetNode);
        });

        var jgName;
        var fscoreValue;
        var idx;
        exp_data.forEach(function(d){
          if(d[2] == pdes){ jgName = d[1];fscoreValue = d[6];idx = d[0];
            console.log("***********d2 |", d[2],"|jgName: ", jgName,"|fscore: ", fscoreValue,"|idx:",idx);
          }
          console.log("***********jgName: ", jgName);
        });
        updateSelectedData(jgName);
        updateSelectedJG(newNodeList, newTargetNodeList, pdes);
        dots.style("fill", function(d){if(d.idx == idx){return "#6699ff";}else{ return "#ffab00";}}).style("visibility", "visible");
      }
      function updateSelectedData(jgName){
        graphData.forEach(function(d){
          if(d["nodes"][0]["id"] == jgName){
            selectedData = d;
            selectedData_nodes = d["nodes"];
            selectedData_links = d["links"];
          }
        });
      }
      var likedList = [];
      var dislikedList = [];
      var exp_data_jgname;
      var dots;

      function likeClicked(ele){
        if(ele.style.color != "green"){
          ele.style.color = "green";

          var checkBtn = $(ele);
          var tr = checkBtn.parent().parent();
          var td = tr.children();
          var pdes = td.eq(0).text();
          likedList.push(pdes);
          console.log("^^^^^^^likedList:^^^^^^", likedList);
        }
        //console.log("likeClicked>>>>>",ele.style.color);
      }
      function dislikeClicked(ele){
        if(ele.style.color != "red"){
          ele.style.color = "red";

          var checkBtn = $(ele);
          var tr = checkBtn.parent().parent();
          var td = tr.children();
          var pdes = td.eq(0).text();
          dislikedList.push(pdes);
          console.log("^^^^^^^dislikedList:^^^^^^", dislikedList);
        }
        //console.log("dislikeClicked>>>>>",ele.style.color);
      }
      //@@
      function ratingUpdate(){
        var postdata = {'likedList':likedList, 'dislikedList':dislikedList};

		    $.ajax({
		      type: 'UD',
		      url: '{{url_for("ratingUD")}}',
		      data: JSON.stringify(postdata),
		      dataType: 'JSON',
		      contentType: "application/json",
          success: function(data){
            if (data.result2){
              exp_len = data.result2.length;
              exp_data = data.result2;
              graphData = data.result3;
              fscoreData = data.result4;
              summaryData = data.result5; ////
              highlightTextList = data.result6;
              node_list = data.result7;
              frac_name = data.result8; 
              frac_value = data.result9;//@@

              //exp_table(exp_data,exp_len,graphData);
              exp_summary(summaryData, exp_data, exp_len, graphData); //exp_summary(summaryData, exp_data, exp_len, fscoreData); 	
		      }else{
            alert("no data");
          }
        },
		      error: function(request, status, error){ 
		        alert(error);
		      }
		    })
      }
      function resetClicked(){
        $("#user_rating_update").empty();//remove update button
        $("#selectedJGexpl").empty(); //remove selecteJG located in the right hand side       
        $("#legend").empty(); //remove legend and fractions in the right hand side
        $("#explanation_table").empty(); //remove filtered explanations

        expTable(exp_len, exp_data, highlightTextList, color_matching); //show the entire explanation table

        dots.style("fill", "#ffab00").style("visibility", "visible"); //make fscore dot all yellow
        selectedData = []; selectedData_nodes = []; selectedData_links = []; //selectedDataIndex = []; //selectedDataId = -1;
      }
      function highlightText(originalTxt, searchKeyword, replaceTxt) {
        const regex = new RegExp(searchKeyword, 'g');
        return originalTxt.toString().replace(regex, replaceTxt);
      }
      function expTable(exp_len, exp_data, highlightTextList, color_matching){
        let expHtml = "";
        expHtml = "<table class=\"table table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"exp\">";
        expHtml += "<tbody>";

        for(var i=0;i<exp_len;i++){
          exp_data_pdesc = exp_data[i][2];
          highlightTextList.forEach(function(element){
            var tmp_element = element.slice(0,-2);
            var setcolor;
            color_matching.forEach(function(d){if(d.name == tmp_element){ setcolor = d.color;}});
            var repstr = "<span style=\"background-color:"+setcolor+";\">"+element+"</span>";
            // exp_data_pdesc = exp_data[i][2];
            //console.log("exp_data_pdesc: ", exp_data_pdesc, "| element: ", element);
            exp_data_pdesc = highlightText(exp_data_pdesc, element, repstr);//exp_data[i] = highlightText(exp_data[i], element, repstr);
            //console.log("highlightText>>>>exp_data_pdesc: ", exp_data_pdesc);
          });

          //expHtml += "<tr><td>"+ exp_data_pdesc +"</td></tr>"; //exp_data[i] //style=\"text-align: center;\"

          expHtml += "<tr><td style=\"width:80%;\">"+ exp_data_pdesc +"</td><td><input style=\"zoom:4.0;\" type=\"checkbox\" name=\"user_checkBox\" onclick=\"checkOne(this)\"></td>";
          expHtml += "<td style=\"width:10%;\">";
          expHtml += "<button type=\"button\" class=\"btn hover1\" id=\"likeBTN\" name=\"user_like\" onclick=\"likeClicked(this)\"><i class=\"fa fa-thumbs-up\"></i></button>";
          expHtml += "<button type=\"button\" class=\"btn hover1\" id=\"dislikeBTN\" name=\"user_dislike\" onclick=\"dislikeClicked(this)\"><i class=\"fa fa-thumbs-down\"></i></button></td></tr>";
        }
        expHtml += "</tbody></table>";

        $("#explanation_table").empty();
        $("#explanation_table").append(expHtml);

        let updateBtnHtml = "";
        updateBtnHtml += "<button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"ratingUpdate()\">Update</button>";  
        $("#user_rating_update").empty();             
        $("#user_rating_update").append(updateBtnHtml);
        
      }
      /////////////////////////////////////////////////@@@@@@@@@@@@@@@@@@@@@@@@@@
      var selectedData; // = [];
      var selectedData_nodes;
      var selectedData_links;
      var selectedDataIndex;
      var selectedDataId;
      var tmpUpdate = new Object();
      var green; var purple;
////////////////////////////////////@@@@@@@@@@@@@@@@@@@@@
      var graphData;

      var fdataset = [];
      function exp(){        
        var expTEXT = "";
        for(var i=0;i<tdArr.length;i++){
          expTEXT += tdArr[i];
          expTEXT += " ";
        }

		    var postdata_exp = { 'tdArr': tdArr, 'colNum': colNum, 'colData': colData}

        $.ajax({
          type: 'EXP',
          url: '{{url_for("explanation")}}',
          data: JSON.stringify(postdata_exp),
          dataType: 'JSON',
          contentType: "application/json",
          success: function(data){
            if (data.result2){
              exp_len = data.result2.length;
              exp_data = data.result2;
              graphData = data.result3;
              //fscoreData = data.result4;
              summaryData = data.result5; ////
              highlightTextList = data.result6;
              node_list = data.result7;
              frac_name = data.result8; 
              frac_value = data.result9;//@@

              //exp_table(exp_data,exp_len,graphData);
              exp_summary(summaryData, exp_data, exp_len, graphData); //exp_summary(summaryData, exp_data, exp_len, fscoreData); 
            } 
            else {
              alert("No data");
            }
          },
		      error: function(request, status, error){ 
		        alert('ajax failed')
		        alert(error);
		      }
        })
        
        function getJGid(tmp_id){
          tmp = tmp_id.split(' ')
          jgID = tmp[0]
          return jgID
        }

      } 

      function exp_summary(summaryData, exp_data, exp_len, graphData){ //(exp_len, recallData, precisionData)
        let sumHtml = "";
        var numOfExp = "The number of explanations: "+exp_len;
        sumHtml = "<table class=\"table table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"exp\"><tbody>";
        sumHtml += "<tr><td style=\"text-align: left;\">Summary</td></tr>";
        sumHtml += "<tr><td style=\"text-align: left;\">1."+ numOfExp +"</td></tr>";
        sumHtml += "</tbody></table>";
        $("#explanation_summary").empty();
        $("#explanation_summary").append(sumHtml);

        //////////////////fscor-d3 scatter plot//////////////////
        var margin = {top: 80, right: 80, bottom: 80, left: 80}, fs_width = 730, fs_height = 300;
        //var dataset = fscoreData.map((d) => {return {"y": d };});
        var fscoreData = [];
        var jgnameId = [];
        for(var i=0;i<summaryData.length;i++){
          fscoreData.push(summaryData[i][1]);
          jgnameId.push(summaryData[i][3]);
        }

        // var fdataset = [];
        fscoreData.forEach(function(key,i){
          var obj = new Object();
          obj['x'] = summaryData[i][2]; obj['y'] = fscoreData[i]; obj['id'] = jgnameId[i];obj['idx'] = summaryData[i][4]; //getJGid(summaryData[i][0])
          //obj['x'] = exp_data[i]; obj['y'] = fscoreData[i]; //obj['id'] = jg_id[i];
          fdataset.push(obj);
        });

        var n = fscoreData.length;

        var xScale = d3.scaleLinear().domain([0, n-1]).range([0, fs_width]); //
        var yScale = d3.scaleLinear().domain([0.1, 1]).range([fs_height, 0]); //[0, 1]

        var svg = d3.select("#explanation_summary")
                    .append("svg")
                    .attr("width", fs_width + margin.left + margin.right)
                    .attr("height", fs_height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform","translate(" + margin.left + "," + margin.top + ")");
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + fs_height + ")")
            .call(d3.axisBottom(xScale));
        svg.append("g").attr("class", "y axis").call(d3.axisLeft(yScale));
        svg.append("text").attr("x", (fs_width/2)).attr("y", 0-(margin.top/2)).attr("text-anchor", "middle")
           .style("font-size", "15px").text("F Score Scatter Plot");
        svg.append("text").attr("text-anchor", "end").attr("x", (fs_width/2)+margin.left)
            .attr("y", fs_height+50).text("The number of explanations");
        svg.append("text").attr("text-anchor", "end").attr("transform", "rotate(-90)").attr("y", -margin.left + 40)
            .attr("x", -margin.top - fs_height/2 + 100).text("F Score");
        var tooltip = d3.select("#explanation_summary")
                      .append("div")
                      .attr("class", "tooltip")
                      .style("background-color", "#a7a7a7")
                      .style("color", "white")
                      .style("border-width", "1px")
                      .style("border-radius", "5px")
                      .style("padding", "10px")
                      .style("position", "absolute")
                      .style("visibility", "hidden");
        var mouseover = function(d) {tooltip.style("opacity", 1).style("visibility", "visible").text(d.x) };
        var mousemove = function(d) {tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px")};
        var mouseout = function(d) { tooltip.style("opacity", 0).style("visibility", "hidden") };
        //var dots =svg.append('g')
        dots = svg.append('g')
          .selectAll("dot")
          .data(fdataset)
          .enter()
          .append("circle")
          .attr("cx", function(d, i) { return xScale(i) })
          .attr("cy", function(d) { return yScale(d.y) })
          .attr("r", 10)
          .style("fill", "#ffab00")
          .style("opacity", 0.5)
          .style("stroke", "white")
          .on("mouseover", mouseover )
          .on("mousemove", mousemove )
          .on("mouseout", mouseout );
        // }

        /////<Generate Random Text Color>
        text_color_list = [];
        hue_list = [0,60,80,120,150,170,190,210,240,270,300,330,345]; //13colors
        hue_list.forEach(function(d){
          text_color_list.push('hsl('+d+',100%,80%)');
        });
        // text_color_list = [];
        // function generateRandomTextColor(length) {
        //     while(text_color_list.length <length){
        //         var hue = Math.floor(Math.random() * 360);
        //         var pastel = 'hsl(' + hue + ', 100%, 80%)';
        //         if(text_color_list.indexOf(pastel) == -1){
        //             text_color_list.push(pastel);
        //         }
        //     }
        // }
        //generateRandomTextColor(highlightTextList.length);

        /////<Node color>
        // var node_length = node_list.length;
        // node_color_list = [];

        // function generateRandomColor(node_length) {
        //   while(node_color_list.length <= node_length){
        //       var hue = Math.floor(Math.random() * 360);
        //       var pastel = 'hsl(' + hue + ', 100%, 80%)';
        //       if(node_color_list.indexOf(pastel) == -1){
        //           node_color_list.push(pastel);
        //       }
        //   }
        // }

        // generateRandomColor(node_length);

        var color_index = -1;
        //var color_matching = [];

        for(var i=0;i<graphData.length;i++){
          tmp = graphData[i]["nodes"];
          for(var j=0;j<tmp.length;j++){
              var obj = tmp[j];

              if(color_index <0){
                color_index++;
                obj.color = text_color_list[color_index];//node_color_list

                var obj_tmp = new Object();
                obj_tmp['name'] = obj['name']; obj_tmp['color'] = text_color_list[color_index];//node_color_list
                color_matching.push(obj_tmp);
              }else{
                matching_check = false;
                for(var t=0;t<color_matching.length;t++){
                  nodeName = color_matching[t]["name"];
                  if(nodeName == obj['name']){
                    obj.color = color_matching[t]['color'];
                    matching_check = true;
                    break;
                  }
                }
                if(matching_check == false){
                  color_index++;
                  obj.color = text_color_list[color_index];//node_color_list

                  var obj_tmp = new Object();
                  obj_tmp['name'] = obj['name']; obj_tmp['color'] = text_color_list[color_index];//node_color_list

                  color_matching.push(obj_tmp);
                }
              }
          }
        }
        /////<Highlight Text>
        // function highlightText(originalTxt, searchKeyword, replaceTxt) {
        //   const regex = new RegExp(searchKeyword, 'g');
        //   return originalTxt.toString().replace(regex, replaceTxt);
        // }
        expTable(exp_len, exp_data, highlightTextList, color_matching); //@@@@@@@@@@@@@@@@@

        // let expHtml = "";
        // expHtml = "<table class=\"table table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"exp\">";
        // expHtml += "<tbody>";
        
        // for(var i=0;i<exp_len;i++){
        //   exp_data_pdesc = exp_data[i][2];
        //   highlightTextList.forEach(function(element){
        //     var tmp_element = element.slice(0,-2);
        //     var setcolor;
        //     color_matching.forEach(function(d){if(d.name == tmp_element){ setcolor = d.color;}});
        //     var repstr = "<span style=\"background-color:"+setcolor+";\">"+element+"</span>";
        //     // exp_data_pdesc = exp_data[i][2];
        //     //console.log("exp_data_pdesc: ", exp_data_pdesc, "| element: ", element);
        //     exp_data_pdesc = highlightText(exp_data_pdesc, element, repstr);//exp_data[i] = highlightText(exp_data[i], element, repstr);
        //     //console.log("highlightText>>>>exp_data_pdesc: ", exp_data_pdesc);
        //   });

        //   //expHtml += "<tr><td>"+ exp_data_pdesc +"</td></tr>"; //exp_data[i] //style=\"text-align: center;\"
          
        //   expHtml += "<tr><td style=\"width:80%;\">"+ exp_data_pdesc +"</td><td><input style=\"zoom:4.0;\" type=\"checkbox\" name=\"user_checkBox\" onclick=\"checkOne(this)\"></td>";
        //   expHtml += "<td style=\"width:10%;\">";
        //   expHtml += "<button type=\"button\" class=\"btn hover1\" id=\"likeBTN\" name=\"user_like\" onclick=\"likeClicked(this)\"><i class=\"fa fa-thumbs-up\"></i></button>";
        //   expHtml += "<button type=\"button\" class=\"btn hover1\" id=\"dislikeBTN\" name=\"user_dislike\" onclick=\"dislikeClicked(this)\"><i class=\"fa fa-thumbs-down\"></i></button></td></tr>";
        // }
        // expHtml += "</tbody></table>";

        // $("#explanation_table").empty();
        // $("#explanation_table").append(expHtml);
        /////////////////////////////////////////////////////////////
        /////<Join Graphs>
        var Data = graphData;
        var width = 400, height = 300;

        (function( $ ) {
          $.fn.generateMultiForce = function(svgObj) {
              return this.each(function() {
                  var graph = this;
                  var graphArea = svgObj.append("g");

                  var svg = d3.select("#explanation_graph")       
                      .append("svg")
                      .attr("width", width)
                      .attr("height", height)//;
                      .data(graph.nodes) //
                      .style("background-color", "white")
                      .on("mouseenter", mouseenter)
                      .on("mouseleave", mouseleave)
                      .on('click', click);

                  var simulation = d3
                      .forceSimulation(graph.nodes)
                      .force("charge", d3.forceManyBody().strength(-1500))
                      .force("center", d3.forceCenter(width / 2, height / 2))
                      .force("link", d3.forceLink(graph.links).id(d => d.name));

                  var link =  svg
                      .append("g")
                      .selectAll("line")
                      .data(graph.links)
                      .enter()
                      .append("line")
                      .attr("stroke-width", 5)
                      .attr("stroke", "#999")
                      .on("mouseover", mouseover) ////
                      .on("mouseout", mouseout) ////
                      .on("mousemove", mousemove); ////

                  var drag = d3
                      .drag()
                      .on("start", dragstarted)
                      .on("drag", dragged)
                      .on("end", dragended);
                  var nodes_with_text = svg
                      .append("g")
                      .selectAll("g")
                      .data(graph.nodes)
                      .enter()
                      .append("g")
                      .call(drag);
                      
                  var circles = nodes_with_text.append("circle").attr("r", 25)
                                                .attr("fill", function(d){ return d.color});//.attr("fill", "#6fbc5b");
                  var texts = nodes_with_text.append("text").text(function(d){ return d.name})
                                              .style("text-anchor", "middle").attr("class", "node-label");
                  var tooltip = d3.select("#explanation_graph")
                                  .append("div")
                                  .style("position", "absolute")
                                  .style("visibility", "hidden")
                                  .style("background-color", "#a7a7a7")
                                  .style("color", "white")
                                  .style("border-width", "1px")
                                  .style("border-radius", "5px")
                                  .style("padding", "10px");

                  simulation.on("tick", function() {
                      link
                          .attr("x1", function(d) { return d.source.x; })
                          .attr("y1", function(d) { return d.source.y; })
                          .attr("x2", function(d) { return d.target.x; })
                          .attr("y2", function(d) { return d.target.y; });

                      nodes_with_text.attr("transform", function(d) {
                          return "translate("+d.x+","+d.y+")";
                      });
                  });
                  function dragstarted(d) {
                      simulation.alphaTarget(0.3).restart();
                      d.fx = d3.event.x;
                      d.fy = d3.event.y;
                  }
                  function dragged(d) {
                      d.fx = d3.event.x;
                      d.fy = d3.event.y;
                  }
                  function dragended(d) {
                      simulation.alphaTarget(0);
                      d.fx = null;
                      d.fy = null;
                  }
                  function mouseover(d) { tooltip.style("visibility", "visible").text(d.cond); }
                  function mouseout() { tooltip.style("visibility", "hidden"); }
                  function mousemove(){ tooltip.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); }
                  ///click function
                  function click(d){
                    console.log("clicked!", d.id);
                      id = d.id;
                      let fscoreY ="";
                      dots.style("fill", function(d,i){
                          if(d.id == id){ fscoreY += " | "+d.y; return "#6699ff";} //"blue" "#b3ccff"
                          else{ return "#ffab00";}}).style("visibility", "visible");
                    //tooltip.style("visibility", "visible").text("clicked: ", d.id);
                    let sumHtml = "";
                    sumHtml = "<table class=\"table table-bordered\" sellspacing=\"0\" width=\"90%\" id=\"exp\"><tbody>";
                    sumHtml += "<tr><td style=\"text-align: left;\">Selected Join Graph</td></tr>";
                    sumHtml += "<tr><td style=\"text-align: left;\">1. Corresponding Fscore:"+fscoreY+"</td></tr>";
                    sumHtml += "</tbody></table>";
                    $("#selectedJGexpl").empty();
                    $("#selectedJGexpl").append(sumHtml);
                    selectedJG(id);
                    //filter explanation table
                    filterExpl(id);
                  }
                  function mouseenter(){ svg.style("background-color", "#ffd889"); }
                  function mouseleave(){ svg.style("background-color", "white"); }
              });
          };
        })(jQuery);

        var svgTest = d3.select("#explanation_graph");
        $(Data).generateMultiForce(svgTest);
        ////@@@
        function filterExpl(id){
          console.log("filterExpl id: ",id);
          
          let newExpHtml = "";
          newExpHtml = "<table class=\"table table-bordered\" sellspacing=\"0\" width=\"90%\"><tbody>";
          
          for(var i=0;i<exp_len;i++){
            exp_data_jgname = exp_data[i][1];
            if(exp_data_jgname == id){
              console.log("exp_data_jgname == id/////////////////: ",exp_data_jgname);
              exp_data_pdesc = exp_data[i][2];
              highlightTextList.forEach(function(element){
                var tmp_element = element.slice(0,-2);
                var setcolor;
                color_matching.forEach(function(d){if(d.name == tmp_element){setcolor = d.color;}});
                var repstr = "<span style=\"background-color:"+setcolor+";\">"+element+"</span>";
                exp_data_pdesc = highlightText(exp_data_pdesc, element, repstr);
              });
              //newExpHtml += "<tr><td>"+ exp_data_pdesc +"</td></tr>";
              newExpHtml += "<tr><td style=\"width:80%;\">"+ exp_data_pdesc +"</td><td><input style=\"zoom:4.0;\" type=\"checkbox\" name=\"user_checkBox\" onclick=\"checkOne(this)\"></td>";
              newExpHtml += "<td style=\"width:10%;\">";
              newExpHtml += "<button type=\"button\" class=\"btn hover1\" id=\"likeBTN\" name=\"user_like\" onclick=\"likeClicked(this)\"><i class=\"fa fa-thumbs-up\"></i></button>";
              newExpHtml += "<button type=\"button\" class=\"btn hover1\" id=\"dislikeBTN\" name=\"user_dislike\" onclick=\"dislikeClicked(this)\"><i class=\"fa fa-thumbs-down\"></i></button></td></tr>";
            }
          } 
          newExpHtml += "</tbody></table>";
          // newExpHtml += "<button type=\"button\" class=\"btn btn-outline-primary\" id=\"checkBoxSelectBtn\" onclick=\"checkBoxSelectBtn()\">UPDATE</button>";
          $("#explanation_table").empty();
          $("#explanation_table").append(newExpHtml);

          // let updateBtnHtml = "";
          // updateBtnHtml += "<button type=\"button\" class=\"btn btn-outline-primary\" onclick=\"ratingUpdate()\">Update</button>";            
          // $("#user_rating_update").append(updateBtnHtml);
        }

        function selectedJG(id){
          console.log("selectedJGexpl id: ",id);
          //
          for(var i=0;i<Data.length;i++){
            if(Data[i]["nodes"][0]["id"] == id){
                  selectedDataIndex = i;
                  selectedData = Data[selectedDataIndex]; /////@@@@@@@
                  selectedData_nodes = Data[selectedDataIndex]["nodes"];
                  selectedData_links = Data[selectedDataIndex]["links"];
                  selectedDataId = selectedData_nodes[0]["id"];
                  console.log("%%%%%%%%%1%%%%%%: ", selectedData); /////@@@@@@@
                  console.log("%%%%%%%%%2%%%%%%: ", selectedData_nodes); /////@@@@@@@
                  console.log("%%%%%%%%%3%%%%%%: ", selectedData_links); /////@@@@@@@
                  
                  var w_selected = 580; var h_selected = 450;
                  var svg = d3.select("#selectedJGexpl").append("svg").attr("width", w_selected).attr("height", h_selected)
                              .data(Data[selectedDataIndex]["nodes"]).style("background-color", "#ccddff"); //b3ccff
                  var simulation = d3.forceSimulation(Data[selectedDataIndex]["nodes"])
                                    .force("charge", d3.forceManyBody().strength(-1500))
                                    .force("center", d3.forceCenter(w_selected/2, h_selected/2))
                                    .force("link", d3.forceLink(Data[selectedDataIndex]["links"]).id(d => d.name));
                  var link =  svg.append("g").selectAll("line").data(Data[selectedDataIndex]["links"]).enter()
                                .append("line").attr("stroke-width", 5).attr("stroke", "#999")
                                .on("mouseover", mouseover).on("mouseout", mouseout).on("mousemove", mousemove);
                  var drag = d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
                  var nodes_with_text = svg.append("g").selectAll("g").data(Data[selectedDataIndex]["nodes"])
                                            .enter().append("g").call(drag);
                  var circles = nodes_with_text.append("circle").attr("r", 25).attr("fill", function(d){ return d.color});//.attr("fill", "#6fbc5b");
                  var texts = nodes_with_text.append("text").text(function(d){ return d.name})
                                              .style("text-anchor", "middle").attr("class", "node-label");
                  var tooltipp = d3.select("#selectedJGexpl").append("div").style("position", "absolute")
                                    .style("visibility", "hidden").style("background-color", "#a7a7a7")
                                    .style("color", "white").style("border-width", "1px")
                                    .style("border-radius", "5px").style("padding", "10px");
                  simulation.on("tick", function() {
                      link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; })
                          .attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });

                      nodes_with_text.attr("transform", function(d) { return "translate("+d.x+","+d.y+")"; });
                  });
                  function dragstarted(d) { simulation.alphaTarget(0.3).restart(); d.fx = d3.event.x; d.fy = d3.event.y; }
                  function dragged(d) { d.fx = d3.event.x; d.fy = d3.event.y; }
                  function dragended(d) { simulation.alphaTarget(0); d.fx = null; d.fy = null; }
                  function mouseover(d) { tooltipp.style("visibility", "visible").text(d.cond); }
                  function mouseout() { tooltipp.style("visibility", "hidden"); }
                  function mousemove(){ tooltipp.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); }
            }
          }          
        }
      }

      function updateSelectedJG(newNodeList, newTargetNodeList, pdes){
        ///<Calculate Fractions>
        var isUser;
        for(var i=0;i<exp_data.length;i++){
          if(exp_data[i][2] == pdes){ isUser = exp_data[i][3]; break;}
        }
        //var isUser = exp_data[i][3];
        // var isUserTmp = isUser.split('AND')[0].split('=')[1];
        // console.log("isUserTmp>>>>>>>>>>>>>>>>>>>>>>>", isUserTmp);

        // var frac_green; var frac_purple;
        // frac_tmp.forEach(function(d){
        //   if(parseInt(d) == parseInt(isUserTmp)){frac_green = parseInt(d);console.log("frac_green>>>>>>>>>>>>>>>>>>>>>>>", frac_green);}
        //   else{frac_purple = parseInt(d);console.log("frac_purple>>>>>>>>>>>>>>>>>>>>>>>", frac_purple);}
        // })
        console.log("isUser : ", isUser);
        console.log("green_text : ", green_text);
        console.log("purple_text : ", purple_text);


        if(isUser == green_text){
          console.log("isUser == green_text!")
          green_frac_index=frac_name.indexOf(isUser);
          frac_green = frac_value[green_frac_index];
          console.log("frac_green : ", frac_green);
          frac_purple = frac_value[1-green_frac_index];
          console.log("frac_purple : ", frac_purple);
          var fracValue_green = Math.round(frac_green*exp_data[i][4]);
          console.log("fracValue_green>>>>>>>>>>>>>>>>>>>>>>>", fracValue_green);
          green = fracValue_green+'/'+frac_green;
          console.log("green>>>>>>>>>>>>>>>>>>>>>>>", green);
          var fracValue_purple = Math.round(frac_green/exp_data[i][5]-frac_green);
          console.log("fracValue_purple>>>>>>>>>>>>>>>>>>>>>>>", fracValue_purple);
          purple = fracValue_purple+'/'+frac_purple;
        }
        else{
          purple_frac_index=frac_name.indexOf(isUser);
          frac_purple = frac_value[purple_frac_index];
          frac_green = frac_value[1-purple_frac_index];
          var fracValue_purple = Math.round(frac_purple*exp_data[i][4]);
          console.log("fracValue_purple>>>>>>>>>>>>>>>>>>>>>>>", fracValue_purple);
          purple = fracValue_purple+'/'+frac_purple;
          console.log("green>>>>>>>>>>>>>>>>>>>>>>>", green);
          var fracValue_green = Math.round(frac_purple/exp_data[i][5]-frac_purple);
          console.log("fracValue_green>>>>>>>>>>>>>>>>>>>>>>>", fracValue_green);
          green = fracValue_green+'/'+frac_green;
        }



        console.log("fracValue_purple>>>>>>>>>>>>>>>>>>>>>>>", purple);
        ///////////////////////////////////////////////////////////
        // console.log("%%%%%%%%%newNodeList: ", newNodeList);
        // console.log("&&&&&&&newTargetNodeList: ",newTargetNodeList);

        // console.log("%%%%%%%%%1@@@@@: ", selectedData); /////@@@@@@@
        // console.log("%%%%%%%%%2@@@@@: ", selectedData_nodes); /////@@@@@@@
        // console.log("%%%%%%%%%3@@@@@: ", selectedData_links); /////@@@@@@@
        // console.log("%%%%%%%%%4@@@@@: ", selectedDataId);

        var obj_Node = [];
        var obj_Link = [];

        for(var i=0;i<selectedData["nodes"].length;i++){
          var objNode = new Object();
          objNode["name"] = selectedData["nodes"][i]["name"];objNode["color"] = selectedData["nodes"][i]["color"];objNode["id"] = selectedDataId;
          obj_Node.push(objNode);
        }
        for(var i=0;i<newNodeList.length;i++){
          var objNodeNew = new Object();
          objNodeNew["name"] = newNodeList[i];objNodeNew["color"] = "hsl(20, 100%, 80%)";objNodeNew["id"] = "attr";//selectedDataId;
          obj_Node.push(objNodeNew);
        }
        tmpUpdate.nodes = obj_Node;

        for(var j=0;j<selectedData["links"].length;j++){
          var objLink = new Object();
          obj_Node.forEach(function(d){
            if(d["name"] == selectedData["links"][j]["source"]["name"]){objLink["source"] = d;}
            if(d["name"] == selectedData["links"][j]["target"]["name"]){objLink["target"] = d;}
          });
          objLink["cond"] = selectedData["links"][j]["cond"];
          obj_Link.push(objLink);
        }
        for(var j=0;j<newTargetNodeList.length;j++){
          var objLink = new Object();
          //objLink["source"] = objNodeNew[j];
          obj_Node.forEach(function(d){
            if(d["name"] == newNodeList[j]){objLink["source"] = d;}
            if(d["name"] == newTargetNodeList[j]){objLink["target"] = d;}
          });
          objLink["cond"] = ""; ///
          obj_Link.push(objLink);              
        }
        tmpUpdate.links = obj_Link;
        console.log("^^^^^^^^^tmpUpdate::: ", tmpUpdate);
        //////////////////////////////////////////
        $("#selectedJGexpl").empty();
        (function( $ ) {
          $.fn.generateMultiForce1 = function(svgObj) {
            return this.each(function() {
              var graph = this;
              var graphArea = svgObj.append("g");
              var active = d3.select(null); ///
              var w = 580; var h = 450;
              var svg = d3.select("#selectedJGexpl").append("svg").attr("width", w).attr("height", h).data(graph.nodes).style("background-color", "#ccddff"); //#b3ccff
                          //.on("mouseenter", mouseenter).on("mouseleave", mouseleave);
              ////@@@@
              var keys = ["relations", "predicates"];
              var shapes = ["circle", "rect"];
              var size = 20;
              var color = d3.scaleOrdinal().domain(shapes).range(keys);
              $("#legend").empty();
              var svg_legend = d3.select("#legend").append("svg").attr("width", w).attr("height", 130).style("background-color", "#ccddff");
              // svg_legend.append("circle").attr("cx", 200).attr("cy", 130).attr("r", 10);
              svg_legend.append("circle").attr("cx", 110).attr("cy", 50).attr("r", 10).style("fill", "#999");
              svg_legend.append("text").attr("x", 130).attr("y", 54).text("relations").style("font-size", "15px").attr("alignment-baseline","middle");
              
              svg_legend.append("rect").attr("x", 350).attr("y", 25).attr("width", size*3).attr("height", size*2).style("fill", "#33ff33");
              svg_legend.append("text").attr("x", 360).attr("y", 50).text(green).style("font-size", "15px").attr("alignment-baseline","middle");
              svg_legend.append("rect").attr("x", 350).attr("y", 25+size*2).attr("width", size*3).attr("height", size*2).style("fill", "#9933ff");
              svg_legend.append("text").attr("x", 360).attr("y", 50+size*2).text(purple).style("font-size", "15px").attr("alignment-baseline","middle");

              svg_legend.append("rect").attr("x", 100).attr("y", 50+size+5).attr("width", size).attr("height", size).style("fill", "#999");
              svg_legend.append("text").attr("x", 130).attr("y", 54+size+5+6).text("predicates").style("font-size", "15px").attr("alignment-baseline","middle");
              //.append("svg").attr("width", w).attr("height", h).style("background-color", "#ccddff"); //@@
              // svg_legend.selectAll("mydots").data(shapes).enter().append(function(d){ return d }).attr("x", 100).attr("y", function(d,i){return 50+i*(size+5)}).attr("width", size).attr("height", size);
              // svg_legend.selectAll("mylabels").data(shapes).enter().append("text").attr("x", 100+size*1.2).attr("y", function(d,i){ return 50 + i*(size+5) + (size/2)})
                        // .style("fill", "#000000").text(function(d){ return color(d)}).attr("text-anchor", "left").style("alignment-baseline", "middle");
              /////////////////
              // var keys = [];
              // var color_list = [];

              // selectedData_nodes.forEach(function(d){keys.push("relations"); color_list.push(d.color);
              // keys.push("predicates"); color_list.push("hsl(20, 100%, 80%)");
              // var color = d3.scaleOrdinal().domain(color_list).range(keys);

              // var size = 20;
              // svg.selectAll("mydots").data(color_list).enter().append("rect").attr("x", 100).attr("y", function(d,i){ return 50 + i*(size+5)})
              //     .attr("width", size).attr("height", size).style("fill", function(d){ return d});
              // svg.selectAll("mylabels").data(color_list).enter().append("text").attr("x", 100 + size*1.2).attr("y", function(d,i){ return 50 + i*(size+5) + (size/2)})
              //     .style("fill", "#000000").text(function(d){ return color(d)}).attr("text-anchor", "left").style("alignment-baseline", "middle");
              /////////////////////

              var simulation = d3.forceSimulation(graph.nodes).force("charge", d3.forceManyBody().strength(-1600))
                      .force("center", d3.forceCenter(w/2, h/2)).force("link", d3.forceLink(graph.links).id(d => d.name))//;
                      // .force("collision", rectCollide().size(function(d){return [d.width, d.height]}))
                      .force("collide", d3.forceCollide().strength(.1).radius(50).iterations(1)); ////@@@@
              var link = svg.append("g").selectAll("line").data(graph.links).enter().append("line").attr("stroke-width", 5)
                              .attr("stroke", "#999").on("mouseover", mouseover).on("mouseout", mouseout).on("mousemove", mousemove);
              var drag = d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
              var nodes_with_text = svg.append("g").selectAll("g").data(graph.nodes).enter().append("g")
                                        .attr("class", function(d){if(d.id == "attr"){return "rt";} else{return "cl";}}).call(drag);
              d3.selectAll(".rt").append("rect").attr("width", 150).attr("height", 25).attr("x", -75).attr("y",-12.5).attr("fill", function(d){ return d.color});
                //.append("text").text(function(d){ return d.name}).style("text-anchor", "middle").style("font-size", "10px").attr("class", "node-label");
              d3.selectAll(".cl").append("circle").attr("r", 25).attr("fill", function(d){ return d.color});
                //.append("text").text(function(d){ return d.name}).style("text-anchor", "middle").style("font-size", "10px").attr("class", "node-label");
              //var circles = nodes_with_text.append("circle").attr("r", 25).attr("fill", function(d){ return d.color});
              var texts = nodes_with_text.append("text").text(function(d){ return d.name}).style("text-anchor", "middle")
                                          .style("font-size", function(d){if(d.id == "attr"){return "12px";} else{return "20px";}}).attr("class", "node-label");
              //#svg
              var tooltiptest = d3.select("#selectedJGexpl").append("div").style("position", "absolute").style("visibility", "hidden").style("background-color", "#a7a7a7")
                              .style("color", "white").style("border-width", "1px").style("border-radius", "5px").style("padding", "10px");
              simulation.on("tick", function() {
                  link.attr("x1", function(d) { return d.source.x; }).attr("y1", function(d) { return d.source.y; })
                      .attr("x2", function(d) { return d.target.x; }).attr("y2", function(d) { return d.target.y; });
                  nodes_with_text.attr("transform", function(d) { return "translate("+d.x+","+d.y+")";});
              });
              function dragstarted(d) {simulation.alphaTarget(0.3).restart();d.fx = d3.event.x;d.fy = d3.event.y;}
              function dragged(d) {d.fx = d3.event.x;d.fy = d3.event.y;}
              function dragended(d) {simulation.alphaTarget(0);d.fx = null;d.fy = null;}
              //function mouseover(d) {tooltiptest.style("visibility", "visible").text(d.cond);}
              function mouseover(d) {if(d.cond != "")tooltiptest.style("visibility", "visible").text(d.cond);}
              function mouseout() {tooltiptest.style("visibility", "hidden");}
              function mousemove(){tooltiptest.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px");}
              // function mouseenter(){svg.style("background-color", "#ffd889");}
              // function mouseleave(){svg.style("background-color", "white");}
            });
          };
        })(jQuery);

        var svg = d3.select("#selectedJGexpl").append("svgUpdate");//.attr("width", width).attr("height", height);
        $(tmpUpdate).generateMultiForce1(svg);
      }

		</script>
    

    <script>
    </script>
		<br>
		
		<div class="row2">
      <br>
		  <div style="display: inline;">
        <div style="float: left; width: 33%; padding: 10px;">
		      <p>Show
		      <select id="dataPerPage" class="form-select" style="width: 70px; display: inline;" onchange="changeRowsSelect()">
		        <option value="10">10</option>
		        <option value="15">15</option>
		        <option value="20">20</option>
		      </select>
		      Rows</p>
		    </div>

        <div style="float: left; padding: 10px; width: 41%; text-align: right;" class="col-md-5">
          <p id="sltROWScount"></p>
        </div>

        <div style="float: right; width: 22%; text-align: right;" id="container"></div>
        
      </div>
		</div>

		<div id="display" style="overflow: auto;"></div><br>    

		<div id="pageInfo" style="display: inline;" class="col-md-12">
		  <div style="float: left;">
		    <p id="displayCount"></p>
		  </div>
		  <div style="float: right;">
		    <ul id="pagingul" class="col-md-6"></ul>
		  </div>

		</div><br>

    <div id="user_rating_update" style="width: 50%;"></div>
    <div id="explanation_table" style="overflow: auto; height: 200px; margin-bottom: 20px;"></div><br><br><br>
    
    <div id="explanation_summary" style="overflow-x: auto; height: 560px; white-space:nowrap; margin-bottom: 20px;"></div> <!--text-align:center;-->
    <div id="explanation_graph" style="overflow-x: auto; height: 320px; white-space:nowrap; margin-bottom: 20px;"></div>
    <div id="reset_JGselection" style="float: left; width:50%;">
      <button type="button" class="btn btn-outline-primary" onclick="resetClicked()">Reset</button>
    </div>

    </div>

    </div>
    <div class="col-md-4"> <!--col-md-3--->
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <div id="schemagraph"></div>
      </div>
      <div id="selectedJGexpl" style="margin-top: 50px;"></div>
      <div id="legend"></div>   <!----->
        <script>
          var svg = d3.select("#schemagraph")            
            .append("svg")
            .attr("width", 580) //400
            .attr("height", 380); //300

          svg.append("defs").append("marker")
              //.attr("id", "arrow")
              .attr("viewBox", "5 -5 10 10")
              .attr("refX", 20)
              .attr("refY", 0)
              .attr("markerWidth", 8)
              .attr("markerHeight", 8)
              .attr("orient", "auto")
            .append("svg:path")
              .attr("d", "M0,-5L10,0L0,5");

          var width = svg.attr("width");
          var height = svg.attr("height");

          var graph = {{schema_graph_data|safe}};

          var simulation = d3
              .forceSimulation(graph.nodes)
              .force("link",d3.forceLink(graph.links).id(function(d) {return d.id;}).distance(120).links(graph.links))
              .force("charge", d3.forceManyBody().strength(-200))
              .force("center", d3.forceCenter(width / 2, height / 2))
              .on("tick", ticked);

            var link = svg.selectAll(".link")
                .data(graph.links)
                .enter()
                .append("g")
                .attr("class", "link")
                .append("line")
                .style("stroke", "blue")
                .attr("class", "link-line")
                //.attr("marker-end", "url(#arrow)")
                .attr("stroke-width", function(d) {return 3;})
                .on("mouseover", mouseover).on("mouseout", mouseout).on("mousemove", mousemove);

            // var linkText = svg.selectAll(".link")
            //     .append("text")
            //     .attr("class", "link-label")
            //     .attr("font-family", "Arial, Helvetica, sans-serif")
            //     .attr("fill", "Black")
            //     .style("font", "normal 12px Arial")
            //     .attr("dy", ".35em")
            //     .attr("text-anchor", "middle")
            //     .text(function(d) {
            //         return d.type;
            //     });

            var drag = d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
            var nodes_with_text = svg.append("g").selectAll("g").data(graph.nodes)
                                      .enter().append("g").call(drag);
            var circles = nodes_with_text.append("circle").attr("r", 15).attr("fill", "red");
            var texts = nodes_with_text.append("text").text(function(d){ return d.name });
            var tooltip_schema = d3.select("#schemagraph").append("div").style("position", "absolute")
                                    .style("visibility", "hidden").style("background-color", "#a7a7a7")
                                    .style("color", "white").style("border-width", "1px")
                                    .style("border-radius", "5px").style("padding", "10px");
            
            function ticked() {
              nodes_with_text.attr("transform", function(d){ return "translate(" + d.x + ", " + d.y + ")";});

              link.attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; });
              // linkText
              //     .attr("x", function(d) {
              //         return ((d.source.x + d.target.x)/2);
              //     })
              //     .attr("y", function(d) {
              //         return ((d.source.y + d.target.y)/2);
              //     });
            };

            function dragstarted(d) { if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                                      d.fx = d.x; d.fy = d.y; };
            function dragged(d) { d.fx = d3.event.x; d.fy = d3.event.y; };
            function dragended(d) { if (!d3.event.active) simulation.alphaTarget(0);
                                    d.fx = null; d.fy = null; };
            function mouseover(d) { tooltip_schema.style("visibility", "visible").text(d.type); }
            function mouseout() { tooltip_schema.style("visibility", "hidden"); }
            function mousemove(){ tooltip_schema.style("top", (d3.event.pageY - 10) + "px").style("left", (d3.event.pageX + 10) + "px"); }
          </script>

        </script>
      <!--</div> -->
    </div>
</div>    
</body>
</html>
